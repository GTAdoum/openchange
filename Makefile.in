# Makefile for OpenChange
# Written by Jelmer Vernooij <jelmer@samba.org>, 2005.

CC=@CC@
CFLAGS=@CFLAGS@ -I. -Wall
PIDL=@PIDL@
PERL=@PERL@
DSOOPT=-shared -fPIC

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
datadir=@datadir@

top_builddir=${PWD}

TORTURE_MODULESDIR=@TORTURE_MODULESDIR@
SERVER_MODULESDIR=${prefix}/modules/dcerpc_server

# Evolution plugin compilation rule
EVOLUTION_PLUGIN=@EVOLUTION_PLUGIN@
EVOLUTION_PLUGIN_INSTALL=@EVOLUTION_PLUGIN_INSTALL@
EVOLUTION_PLUGIN_UNINSTALL=@EVOLUTION_PLUGIN_UNINSTALL@
INTLTOOL_MERGE=@INTLTOOL_MERGE@
plugindir=@plugindir@
camel_providerdir=@camel_providerdir@

EVOLUTION_PLUGIN_LIBS=@EVOLUTION_PLUGIN_LIBS@
EVOLUTION_PLUGIN_CFLAGS=@EVOLUTION_PLUGIN_CFLAGS@

# This value should be determined by configure at some point
SHLIBEXT=so

LIBS+=-lpopt 

# Portability hack...
CFLAGS+=-Duint_t="unsigned int" 

CFLAGS+=@SAMBA_CFLAGS@
LIBS+=@SAMBA_LIBS@

CFLAGS+=@LDB_CFLAGS@ @TALLOC_CFLAGS@
LIBS+=@LDB_LIBS@ @TALLOC_LIBS@

all: 	ndr_exchange.h proto.h mapi_proto.h torture_proto.h bin/schemaIDGUID \
	bin/locale_codepage torture/openchange.$(SHLIBEXT) \
	server/dcesrv_exchange.$(SHLIBEXT) \
	server/dcesrv_exchange_remote.$(SHLIBEXT) $(EVOLUTION_PLUGIN)

install: all $(EVOLUTION_PLUGIN_INSTALL)
	@echo "=============================="
	@echo "Installing OpenChange plugin"
	mkdir -p $(DESTDIR)$(bindir) $(DESTDIR)$(libdir)
	mkdir -p $(TORTURE_MODULESDIR)
	mkdir -p $(DESTDIR)$(SERVER_MODULESDIR)
	cp bin/schemaIDGUID $(DESTDIR)$(bindir)
	cp bin/locale_codepage $(DESTDIR)$(bindir)
	cp libmapi.$(SHLIBEXT) $(DESTDIR)$(libdir)
	cp torture/openchange.$(SHLIBEXT) $(DESTDIR)$(TORTURE_MODULESDIR)
	cp server/dcesrv_exchange.$(SHLIBEXT) $(DESTDIR)$(SERVER_MODULESDIR)
	cp server/dcesrv_exchange_remote.$(SHLIBEXT) $(DESTDIR)$(SERVER_MODULESDIR)
	cp scripting/libjs/*.js $(DESTDIR)$(datadir)/js/
	cp setup/*.ldif $(DESTDIR)$(datadir)/setup/
	@echo "OpenChange plugin installed"

uninstall: $(EVOLUTION_PLUGIN_UNINSTALL)
	rm -f $(DESTDIR)$(bindir)/schemaIDGUID
	rm -f $(DESTDIR)$(bindir)/locale_codepage
	rm -f $(DESTDIR)$(libdir)/libmapi.*
	rm -f $(DESTDIR)$(TORTURE_MODULESDIR)/openchange.*
	rm -f $(DESTDIR)$(SERVER_MODULESDIR)/dcesrv_exchange.*
	rm -f $(DESTDIR)$(datadir)/js/oc_provision.js
	rm -f $(DESTDIR)$(datadir)/setup/oc_provision_configuration.ldif
	rm -f $(DESTDIR)$(datadir)/setup/oc_provision_schema.ldif
	rm -f $(DESTDIR)$(datadir)/setup/oc_provision_schema_modify.ldif

re: clean install

# Evolution plugin compilation

evolution-plugin-all: client/evolution/camelprovider/libcamel-openchange.$(SHLIBEXT) client/evolution/eplugin/org-gnome-openchange-plugin.eplug client/evolution/eplugin/liborg-gnome-openchange-plugin.$(SHLIBEXT)

evolution-plugin-install: evolution-plugin-all
	cp client/evolution/camelprovider/libcamelopenchange.urls $(camel_providerdir)
	cp client/evolution/camelprovider/libcamel-openchange.$(SHLIBEXT) $(camel_providerdir)
	cp client/evolution/eplugin/org-gnome-openchange-plugin.eplug $(plugindir)
	cp client/evolution/eplugin/liborg-gnome-openchange-plugin.$(SHLIBEXT) $(plugindir)

evolution-plugin-uninstall:
	rm -f $(camel_providerdir)/libcamelopenchange.urls
	rm -f $(camel_providerdir)/libcamel-openchange.$(SHLIBEXT)
	rm -f $(plugindir)/org-gnome-openchange-plugin.eplug
	rm -f $(plugindir)/liborg-gnome-openchange-plugin.$(SHLIBEXT)

client/evolution/eplugin/%.o: CFLAGS+=$(EVOLUTION_PLUGIN_CFLAGS)
client/evolution/eplugin/liborg-gnome-openchange-plugin.$(SHLIBEXT):  client/evolution/eplugin/openchange-plugin.o
	@echo "Linking $<"
	@$(CC) -o $@ $(DSOOPT) $^ -L. $(EVOLUTION_PLUGIN_LIBS)

%.eplug: %.eplug.in
	sed -e 's|\@PLUGINDIR\@|$(plugindir)|' -e 's|\@SOEXT\@|.$(SHLIBEXT)|' $< > $@

client/evolution/camelprovider/%.o: CFLAGS+=$(EVOLUTION_PLUGIN_CFLAGS)
client/evolution/camelprovider/libcamel-openchange.$(SHLIBEXT): client/evolution/camelprovider/camel-openchange-transport.o client/evolution/camelprovider/camel-openchange-provider.o
	@echo "Linking $<"
	@$(CC) -o $@ $(DSOOPT) $^ -L. $(EVOLUTION_PLUGIN_LIBS)

torture/openchange.$(SHLIBEXT): torture/testjoin_exchange.o torture/emsmdb.o torture/exchange.o torture/nspi.o torture/nspi_profile.o torture/openchange.o torture/nspi_scantags.o 
	@echo "Compiling $<"
	@$(CC) -o $@ $(DSOOPT) $^ -L. $(LIBS) -lmapi

server/dcesrv_exchange.$(SHLIBEXT): providers/emsabp.o server/dcesrv_exchange.o
	@echo "Compiling $<"
	@$(CC) -o $@ $(DSOOPT) $^ -L. -lmapi $(LIBS)

server/dcesrv_exchange_remote.$(SHLIBEXT): server/dcesrv_exchange_remote.o
	@echo "Compiling $<"
	@$(CC) -o $@ $(DSOOPT) $^ -L. -lmapi $(LIBS)

exchange.idl: mapitags_enum.h mapicodes_enum.h

%.h: %.idl
	@echo "Compiling $<"
	@$(PIDL) --outputdir=$(@D) --header -- $<

.c.o:
	@echo "Compiling $<"
	@$(CC) $(EPLUGINS_UI_CFLAGS) $(CFLAGS) -c $< -o $@

ndr_%.h ndr_%.c: %.idl %.h
	@echo "Compiling $<"
	@$(PIDL) --outputdir=$(@D) --ndr-parser -- $<

ndr_%_c.h ndr_%_c.c: %.idl %.h
	@echo "Compiling $<"
	@$(PIDL) --outputdir=$(@D) --client -- $<

ndr_%_s.c: %.idl
	@echo "Compiling $<"
	@$(PIDL) --outputdir=$(@D) --server -- $<

server/dcesrv_exchange.c: providers_proto.h ndr_exchange_s.c ndr_exchange.c

libmapi/emsmdb.c: libmapi/include/emsmdb.h ndr_exchange_c.h

libmapi/mapitags.c libmapi/mapicode.c mapitags_enum.h mapicodes_enum.h: libmapi/conf/mapi-properties libmapi/conf/mapi-codes libmapi/conf/mparse.pl
	@./libmapi/conf/build.sh

bin/schemaIDGUID: utils/schemaIDGUID.o
	@echo "Compiling $<"
	@$(CC) -o $@ $^ $(LIBS)

bin/locale_codepage: libmapi/tests/locale_codepage.o libmapi.$(SHLIBEXT)
	@echo "Compiling $<"
	@$(CC) -o $@ $^ $(LIBS)

distclean: clean
	rm -rf autom4te.cache
	rm -f Makefile config.status config.log
	rm -f intltool-extract intltool-merge intltool-update

realdistclean: distclean
	rm -f libmapi.so
	rm -f torture/openchange.so
	rm -f server/dcesrv_exchange.so
	rm -f server/dcesrv_exchange_remote.so
	rm -f client/evolution/*/*.so

clean:
	rm -f libmapi/generated/*
	rm -f libmapi/*.o
	rm -f libmapi/tests/*.o
	rm -f libmapi/util/*.o
	rm -f tests/*.o
	rm -f bin/*
	rm -f server/*.o
	rm -f providers/*.o
	rm -f torture/*.o
	rm -f utils/*.o
	rm -f ndr_exchange* exchange.h
	rm -f libmapi/mapicode.{c,h}
	rm -f libmapi/mapitags.{c,h}
	rm -f libmapi/include/proto.h
	rm -f libmapi/include/mapi_proto.h
	rm -f providers/providers_proto.h
	rm -f torture/*.$(SHLIBEXT) server/*.$(SHLIBEXT)
	rm -f torture/torture_proto.h
	rm -f ndr_mapi.o
	rm -f mapicodes_enum.h
	rm -f mapitags_enum.h
	rm -f client/evolution/*/*.o client/evolution/*/*.eplug
	rm -f *~
	rm -f */*~
	rm -f */*/*~

proto.h: libmapi/mapitags.c libmapi/mapicode.c
	@echo "Generating proto.h"
	@./script/mkproto.pl --private=libmapi/include/proto.h --public=libmapi/include/proto.h \
	libmapi/x500.c libmapi/mapitags.c libmapi/mapicode.c libmapi/utils.c \
	libmapi/util/locale.c libmapi/util/codepage.c 

mapi_proto.h:
	@echo "Generating mapi_proto.h"
	@./script/mkproto.pl --private=libmapi/include/mapi_proto.h --public=libmapi/include/mapi_proto.h \
	libmapi/property.c libmapi/nspi.c libmapi/emsmdb.c

providers_proto.h: providers/emsabp.c
	@echo "Generating providers_proto.h"
	@./script/mkproto.pl --private=providers/providers_proto.h --public=providers/providers_proto.h \
	providers/emsabp.c

torture_proto.h:
	@echo "Generating torture_proto.h"
	@./script/mkproto.pl --private=torture/torture_proto.h --public=torture/torture_proto.h torture/testjoin_exchange.c

libmapi.$(SHLIBEXT): libmapi/utils.o libmapi/property.o	\
				libmapi/mapitags.o libmapi/mapicode.o	\
				libmapi/emsmdb.o libmapi/nspi.o		\
				ndr_exchange.o libmapi/util/locale.o	\
				libmapi/util/codepage.o			\
				ndr_mapi.o ndr_exchange_c.o		\
				libmapi/x500.o
	@echo "Compiling $<"
	@$(CC) $(DSOOPT) -o $@ $^ $(LIBS)

etags:
	etags `find $(srcdir) -name "*.[ch]"`

ctags:
	ctags `find $(srcdir) -name "*.[ch]"`

.PRECIOUS: exchange.h ndr_exchange.h ndr_exchange.c ndr_exchange_c.c ndr_exchange_c.h

Makefile: Makefile.in config.status
	./config.status
